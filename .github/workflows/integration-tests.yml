name: Integration Tests

on:
  schedule:
    # Run integration tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Set up test database
      run: |
        # Run database migrations/setup for testing
        npm run setup
      env:
        SUPABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        SUPABASE_SERVICE_ROLE_KEY: test_key
    
    - name: Run integration tests
      run: |
        # Add integration test commands here
        # npm run test:integration
        echo "Integration tests would run here"
      env:
        SUPABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        SUPABASE_SERVICE_ROLE_KEY: test_key
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    
    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'Integration Tests Failed',
            body: 'The daily integration tests have failed. Please check the logs.',
            labels: ['bug', 'integration-test']
          })
